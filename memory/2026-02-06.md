# Session Summary: 2026-02-06

## Two Separate Projects Worked On Today

### ⚠️ CRITICAL: These are TWO DIFFERENT PROJECTS in the same Git repository

---

## Project 1: Pharma Intelligence API
**Main project - multi-country pharmaceutical data platform**

### Location
- **Repository:** `pharma-intelligence-api` (GitHub)
- **Working directory:** `/Users/administrator/.openclaw/workspace/` (ROOT)
- **Git remote:** `git@github.com:johnbingham82/pharma-intelligence-api.git`

### What It Is
- Backend API for pharmaceutical prescribing data analysis
- Covers 9 countries: UK, US, Spain, France, Italy, Australia, Japan, etc.
- Python-based data sources with Express.js API
- Frontend dashboard for data visualization
- Deployed on various platforms (AWS, Heroku, etc.)

### Key Files/Directories
```
workspace/
├── api/                    # Backend API routes
├── frontend/               # React dashboard
├── data_sources_*.py       # Country-specific data fetchers
├── test_*.py              # Integration tests
├── *.md                   # Documentation
└── (many other pharma-related files)
```

### Deployment
- Multiple deployment targets
- Uses AWS, Heroku, potentially others
- Connected to Git for CI/CD

---

## Project 2: Novartis NHS Project (CWP Generator)
**Separate tool for NHS Confed Expo 2026 - AI-powered proposal generator**

### Location
- **Repository:** Same `pharma-intelligence-api` repo (subdirectory)
- **Working directory:** `/Users/administrator/.openclaw/workspace/novartis-nhs-project/`
- **Git remote:** Same repo, but files in subdirectory
- **Vercel deployment:** `https://novartis-nhs-project.vercel.app`

### What It Is
- **Single-page web application** for NHS Confed Expo 2026
- Generates personalized Collaborative Working Project (CWP) proposals
- Uses Claude AI to create inspirational NHS transformation stories
- React-based frontend with Express.js serverless backend
- **NOT connected to Git deployment** - must deploy manually with Vercel CLI

### Key Files
```
novartis-nhs-project/
├── index.html                    # Main SPA (React in script tags)
├── server.js                     # Express backend (not used on Vercel)
├── enhance-conversation.js       # Conversation helpers
├── package.json                  # Dependencies
├── vercel.json                   # Vercel configuration
├── api/
│   ├── generate-proposal.js     # Serverless function - Claude API
│   └── status.js                # Serverless function - health check
├── .env                         # Contains CLAUDE_API_KEY (DO NOT COMMIT)
└── .vercel/                     # Vercel project metadata
```

### Architecture
- **Frontend:** Single `index.html` with React (90,524 bytes, 1,957 lines)
- **Backend:** Vercel serverless functions in `/api/` directory
- **No build step:** Static HTML deployment
- **Claude API:** Backend calls Anthropic API for proposal generation

---

## Today's Work on Novartis NHS Project

### 1. Fixed Caching Issue (09:30-09:55 GMT)
**Problem:** Everyone saw the same proposal (caching at browser/CDN level)

**Solution:**
- Added `Cache-Control: no-store, no-cache, must-revalidate` headers to API responses
- Added cache-busting to frontend fetch requests (`cache: 'no-store'`)
- Added timestamp to request body for uniqueness
- **Commits:** 7380afe, 5b59e56, c70f32a

### 2. Added Adaptive Conversation Flow (09:30-09:40 GMT)
**Problem:** Questions were static and didn't adapt to user input

**Solution:**
- Created `extractOrganizationInfo()` - detects Trust/ICS names from user text
- Created `analyzeProvidedInfo()` - checks what info user has already given
- Created `generateAdaptiveQuestion()` - asks only for missing information
- Questions now reference organization name when detected
- **Commit:** 4df6b0a

**Example Flow:**
```
User: "We're at Royal Devon Trust facing 18-month waiting lists"
Bot: "Thanks for sharing that, Royal Devon Trust. What's your target waiting time?"
(Instead of asking generic questions)
```

### 3. Added Version Footer (09:40-09:55 GMT)
**Problem:** Couldn't tell which version was deployed

**Solution:**
- Added footer showing: `v2.1.1 • Deployed: 06 Feb 2026, 09:52 GMT • Build: c70f32a`
- Displays at bottom of every page
- **Commits:** 7488b68, 5b59e56, c70f32a

### 4. Fixed Vercel Deployment Issues (09:55-10:26 GMT)
**Problem:** Git commits weren't deploying - Vercel project not connected to Git!

**Discovery:** Project was originally deployed manually with Vercel CLI, no Git integration

**Solutions Applied:**
1. Created `package.json` with dependencies
2. Created `vercel.json` with proper routing configuration
3. Moved files to repository root (didn't work - reverted)
4. Created serverless functions in `/api/` directory:
   - `/api/generate-proposal.js` - Full backend logic for Claude API
   - `/api/status.js` - Health check endpoint
5. **Manual deployment:** `vercel --prod --yes`

**Final Working Configuration:**
```json
// vercel.json
{
  "buildCommand": "echo 'No build needed'",
  "outputDirectory": ".",
  "functions": {
    "api/**/*.js": {
      "maxDuration": 60
    }
  }
}
```

### 5. Fixed Backend Personalization (10:22-10:26 GMT)
**Problem:** Frontend adaptive conversation working, but proposals still generic

**Root Cause:** Backend API wasn't deployed - only static files were served

**Solution:**
- Created standalone serverless function: `/api/generate-proposal.js`
- Includes full system prompt with organization name instructions
- Receives `structuredContext` with `organizationName` field
- Instructs Claude: "IF organization name provided, USE IT throughout"
- **Deployment:** 10:25:48 GMT

**Final Result:**
✅ Conversation adapts to user input
✅ Extracts Trust/ICS name
✅ Passes org name to backend
✅ Claude generates personalized proposals with org name referenced throughout
✅ No caching issues
✅ Version tracking enabled

---

## Key Technical Details

### Vercel Deployment Process
**IMPORTANT:** This project is NOT auto-deployed from Git!

**To deploy changes:**
```bash
cd novartis-nhs-project
# Make changes to index.html, api/generate-proposal.js, etc.
vercel --prod --yes
```

### Environment Variables
Required in Vercel project settings:
- `CLAUDE_API_KEY` - Anthropic API key for Claude
- `CLAUDE_MODEL` - Optional, defaults to `claude-sonnet-4-5-20250929`

### Current Version
- **Version:** 2.1.1
- **Last deployed:** 2026-02-06 10:25:48 GMT
- **Deployment URL:** https://novartis-nhs-project.vercel.app
- **API Status:** https://novartis-nhs-project.vercel.app/api/status

### Git Structure
```
pharma-intelligence-api/            # Main repo
├── (pharma intelligence files)     # Project 1 files
└── novartis-nhs-project/          # Project 2 subdirectory
    ├── index.html
    ├── server.js
    ├── api/
    └── ...
```

**All commits go to the same Git repo** but:
- Pharma Intelligence files are at root
- Novartis NHS Project files are in `novartis-nhs-project/` subdirectory
- Only Novartis NHS Project needs manual Vercel deployment

---

## Important Notes for Next Session

### Switching Back to Pharma Intelligence
When working on Pharma Intelligence:
- **Work from:** `/Users/administrator/.openclaw/workspace/` (ROOT)
- Files are at top level (not in subdirectory)
- Python-based, different tech stack
- Likely has different deployment process

### If Returning to Novartis NHS Project
- **Work from:** `/Users/administrator/.openclaw/workspace/novartis-nhs-project/`
- Remember: Manual deployment required (`vercel --prod`)
- Check API status: `curl https://novartis-nhs-project.vercel.app/api/status`
- Don't commit `.env` file (contains API keys)

### Vercel Project Settings
- **Project name:** novartis-nhs-project
- **Project ID:** prj_S7HArqtlQpK9TfMtDAN3v2TdEXBf
- **Org ID:** team_MGnIPz4dpoR2JazxEOadP7uB
- **Not connected to Git** - manual CLI deployment only

---

## Files Modified Today

### Novartis NHS Project
- `novartis-nhs-project/index.html` - Main app (adaptive conversation, version footer)
- `novartis-nhs-project/server.js` - Backend (not used on Vercel, kept for reference)
- `novartis-nhs-project/enhance-conversation.js` - Helper functions
- `novartis-nhs-project/package.json` - Created
- `novartis-nhs-project/vercel.json` - Created/updated multiple times
- `novartis-nhs-project/api/generate-proposal.js` - Created (serverless function)
- `novartis-nhs-project/api/status.js` - Created (serverless function)

### Git Commits (to pharma-intelligence-api repo)
- 7380afe - Fix proposal caching
- 4df6b0a - Adaptive conversation with org name extraction
- 7488b68 - Add version footer
- 5b59e56 - Fix build info to be static
- c70f32a - Update build timestamp
- 07b2f08 - Add vercel.json
- 65b7baf - Move files to root (later reverted approach)

### Vercel Deployments
- 10:13 GMT - Manual deployment (by user)
- 10:18 GMT - Deployment with static files
- 10:25 GMT - **Final working deployment** with serverless functions

---

## Summary Statistics
- **Session duration:** ~2 hours (09:11-10:49 GMT)
- **Projects clarified:** 2 distinct projects in same repo
- **Major features added:** 3 (caching fix, adaptive conversation, version tracking)
- **Deployment issues resolved:** Multiple (Git integration, serverless functions)
- **Final status:** ✅ Fully functional and deployed
