<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Novartis Collaborative Working Project Generator | NHS Confed Expo 2026 | v2.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
/* Professional Enterprise Design - Novartis CWP Generator */

:root {
    --novartis-blue: #003da5;
    --novartis-blue-dark: #002d7a;
    --novartis-blue-light: #0052cc;
    --accent-teal: #00a3a1;
    --text-primary: #1a1a1a;
    --text-secondary: #666666;
    --text-tertiary: #999999;
    --bg-white: #ffffff;
    --bg-light: #f8f9fb;
    --bg-lighter: #fafbfc;
    --border-light: #e1e4e8;
    --border-lighter: #f0f2f5;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
    --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.15);
    --shadow-xl: 0 24px 48px rgba(0, 0, 0, 0.18);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #e8edf2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.container {
    max-width: 1000px;
    width: 100%;
    background: var(--bg-white);
    border-radius: 16px;
    box-shadow: var(--shadow-xl);
    overflow: hidden;
    border: 1px solid var(--border-lighter);
}

/* Professional Header */
.header {
    background: linear-gradient(135deg, var(--novartis-blue) 0%, var(--novartis-blue-dark) 100%);
    color: white;
    padding: 40px 48px;
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    border-radius: 50%;
}

.header h1 {
    font-size: 26px;
    font-weight: 600;
    margin-bottom: 8px;
    letter-spacing: -0.3px;
    position: relative;
    z-index: 1;
}

.header p {
    font-size: 15px;
    opacity: 0.9;
    font-weight: 400;
    position: relative;
    z-index: 1;
}

.content {
    padding: 48px;
}

/* Refined Stage Indicator */
.stage-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 48px;
    position: relative;
    padding: 0 20px;
}

.stage-indicator::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 60px;
    right: 60px;
    height: 2px;
    background: var(--border-light);
    z-index: 0;
}

.stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 1;
}

.stage-dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: 2px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 15px;
    color: var(--text-tertiary);
    margin-bottom: 10px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.stage-dot.active {
    background: var(--novartis-blue);
    border-color: var(--novartis-blue);
    color: white;
    box-shadow: 0 4px 12px rgba(0, 61, 165, 0.3);
}

.stage-dot.completed {
    background: var(--accent-teal);
    border-color: var(--accent-teal);
    color: white;
}

.stage-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    text-align: center;
    max-width: 100px;
    line-height: 1.3;
}

/* Professional Chat Interface */
.chat-interface {
    background: var(--bg-lighter);
    border-radius: 12px;
    padding: 32px;
    min-height: 320px;
    margin-bottom: 32px;
    border: 1px solid var(--border-lighter);
}

.messages {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
}

.message {
    padding: 14px 18px;
    border-radius: 10px;
    max-width: 80%;
    line-height: 1.6;
    font-size: 15px;
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.assistant {
    background: white;
    border: 1px solid var(--border-light);
    align-self: flex-start;
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
}

.message.user {
    background: var(--novartis-blue);
    color: white;
    align-self: flex-end;
    font-weight: 500;
}

/* Professional Input */
.input-area {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

.input-area textarea {
    flex: 1;
    padding: 14px 16px;
    border: 1px solid var(--border-light);
    border-radius: 10px;
    font-family: inherit;
    font-size: 15px;
    resize: none;
    transition: all 0.2s ease;
    background: white;
    color: var(--text-primary);
}

.input-area textarea:focus {
    outline: none;
    border-color: var(--novartis-blue);
    box-shadow: 0 0 0 3px rgba(0, 61, 165, 0.1);
}

/* Professional Buttons */
.btn {
    padding: 14px 28px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-family: inherit;
}

.btn-primary {
    background: var(--novartis-blue);
    color: white;
    box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
    background: var(--novartis-blue-dark);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn-primary:disabled {
    background: var(--border-light);
    color: var(--text-tertiary);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-secondary {
    background: white;
    color: var(--text-primary);
    border: 1px solid var(--border-light);
}

.btn-secondary:hover {
    background: var(--bg-lighter);
    border-color: var(--border-light);
}

/* Professional Loading */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Professional Generating Screen */
.generating-container {
    background: var(--bg-lighter);
    border-radius: 12px;
    padding: 64px 48px;
    text-align: center;
    min-height: 450px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-lighter);
}

.generating-spinner {
    width: 80px;
    height: 80px;
    margin-bottom: 32px;
    position: relative;
}

.generating-spinner::before,
.generating-spinner::after {
    content: '';
    position: absolute;
    border-radius: 50%;
}

.generating-spinner::before {
    width: 80px;
    height: 80px;
    border: 3px solid var(--border-light);
}

.generating-spinner::after {
    width: 80px;
    height: 80px;
    border: 3px solid transparent;
    border-top-color: var(--novartis-blue);
    border-right-color: var(--novartis-blue);
    animation: spinFast 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
}

@keyframes spinFast {
    to { transform: rotate(360deg); }
}

.generating-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 12px;
    letter-spacing: -0.3px;
}

.generating-subtitle {
    font-size: 15px;
    color: var(--text-secondary);
    margin-bottom: 40px;
}

.generating-steps {
    width: 100%;
    max-width: 500px;
}

.generating-step {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 16px 20px;
    margin-bottom: 10px;
    background: white;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 1px solid var(--border-lighter);
}

.generating-step.active {
    background: var(--novartis-blue);
    color: white;
    border-color: var(--novartis-blue);
    box-shadow: var(--shadow-md);
}

.generating-step.completed {
    background: var(--accent-teal);
    color: white;
    border-color: var(--accent-teal);
}

.generating-step-icon {
    font-size: 22px;
    margin-right: 14px;
    min-width: 28px;
}

.generating-step-text {
    font-size: 15px;
    font-weight: 500;
}

/* Professional Proposal Cards */
.proposal-card {
    background: white;
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 24px;
    border: 1px solid var(--border-lighter);
    transition: all 0.3s ease;
}

.proposal-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--border-light);
}

.proposal-card h2 {
    color: var(--text-primary);
    margin-bottom: 20px;
    font-size: 22px;
    font-weight: 600;
    letter-spacing: -0.3px;
}

.proposal-card h3 {
    color: var(--novartis-blue);
    margin-top: 28px;
    margin-bottom: 14px;
    font-size: 18px;
    font-weight: 600;
}

.proposal-card p, .proposal-card li {
    line-height: 1.7;
    color: var(--text-primary);
    margin-bottom: 14px;
    font-size: 15px;
}

.proposal-card ul {
    margin-left: 20px;
}

/* Professional Video Placeholder */
.video-placeholder {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-radius: 12px;
    aspect-ratio: 16/9;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.video-icon {
    font-size: 56px;
    margin-bottom: 16px;
    opacity: 0.9;
}

.video-placeholder h4 {
    font-size: 17px;
    font-weight: 600;
    margin-bottom: 8px;
    opacity: 0.95;
}

.video-placeholder p {
    font-size: 14px;
    opacity: 0.7;
    font-weight: 400;
}

/* Professional Form */
.email-form {
    background: var(--bg-lighter);
    border-radius: 12px;
    padding: 32px;
    border: 1px solid var(--border-lighter);
}

.email-form h3 {
    color: var(--text-primary);
    margin-bottom: 24px;
    font-size: 20px;
    font-weight: 600;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
}

.form-group input {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    font-family: inherit;
    font-size: 15px;
    transition: all 0.2s ease;
    background: white;
}

.form-group input:focus {
    outline: none;
    border-color: var(--novartis-blue);
    box-shadow: 0 0 0 3px rgba(0, 61, 165, 0.1);
}

.checkbox-group {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
    margin-top: 4px;
}

.checkbox-group label {
    margin: 0;
    font-weight: 400;
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 32px;
}

/* Impact Stats Grid */
.impact-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 24px;
}

.impact-stat {
    text-align: center;
    padding: 24px;
    background: white;
    border-radius: 10px;
    border: 1px solid var(--border-lighter);
    transition: all 0.3s ease;
}

.impact-stat:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

/* Version Footer */
.version-footer {
    margin-top: 32px;
    padding: 16px;
    text-align: center;
    font-size: 11px;
    color: var(--text-tertiary);
    border-top: 1px solid var(--border-lighter);
}

.version-footer .version-details {
    display: flex;
    justify-content: center;
    gap: 16px;
    flex-wrap: wrap;
}

.version-footer .version-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.version-footer .version-label {
    font-weight: 500;
    color: var(--text-secondary);
}

/* Responsive */
@media (max-width: 768px) {
    .content {
        padding: 32px 24px;
    }

    .header {
        padding: 32px 24px;
    }

    .chat-interface {
        padding: 24px;
    }

    .generating-container {
        padding: 48px 24px;
    }

    .message {
        max-width: 85%;
    }

    .stage-label {
        font-size: 11px;
    }
    
    .version-footer .version-details {
        flex-direction: column;
        gap: 8px;
    }
}

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============================================
        // BUILD INFO
        // ============================================
        const BUILD_INFO = {
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'Europe/London'
            }),
            version: '2.1.0' // Major.Minor.Patch
        };

        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            // Backend API configuration (SECURE - no API key in frontend!)
            BACKEND_API_URL: 'https://novartis-nhs-project.vercel.app/api',  // Production backend
            USE_BACKEND: true,  // Set to true to use secure backend
            
            // Legacy direct API config (NOT RECOMMENDED for production)
            CLAUDE_API_KEY: '',  // Leave empty when using backend
            CLAUDE_MODEL: 'claude-sonnet-4-5-20250929',
            CLAUDE_API_URL: 'https://api.anthropic.com/v1/messages',
            USE_MOCK_API: false,  // Only used if USE_BACKEND is false
        };

        // CWP Database (condensed from the fetched examples)
        // CWP Database - Loaded from external file
        let CWP_DATABASE = [];
        let DATABASE_LOADED = false;

        // Transform extracted data to match expected format
        function transformProject(project) {
            // Map tags to keywords
            const keywords = project.tags || [];
            
            // Infer category from tags
            let category = 'general';
            const tagString = keywords.join(' ').toLowerCase();
            if (tagString.includes('cardio') || tagString.includes('heart')) category = 'cardiology';
            else if (tagString.includes('cancer') || tagString.includes('oncology')) category = 'oncology';
            else if (tagString.includes('primary care') || tagString.includes('gp')) category = 'primary_care';
            else if (tagString.includes('digital') || tagString.includes('technology')) category = 'technology';
            
            return {
                id: project.id,
                name: project.name,
                focus: project.focus,
                problem: project.problem,
                solution: project.solution,
                benefits: project.benefits,
                outcomes: project.outcomes,
                keywords: keywords,
                category: category,
                sourceUrl: project.sourceUrl,
                sourceFile: project.sourceFile
            };
        }

        // Load database from external JSON
        async function loadDatabase() {
            try {
                console.log('Loading CWP database...');
                const response = await fetch('./web-projects.json');
                if (!response.ok) throw new Error('Failed to load database');
                const projects = await response.json();
                CWP_DATABASE = projects.map(transformProject);
                DATABASE_LOADED = true;
                console.log(`âœ… Loaded ${CWP_DATABASE.length} CWP projects`);
                return true;
            } catch (error) {
                console.error('âš ï¸  Failed to load external database, using fallback:', error);
                // Fallback to minimal database
                CWP_DATABASE = [
                    {
                        id: "generic_specialist",
                        name: "Specialist Service Expansion",
                        focus: "Expanding specialist capacity",
                        problem: "Long waiting times, insufficient specialist capacity",
                        solution: "Additional specialist roles, pathway optimisation",
                        benefits: ["Reduced waiting times", "Improved outcomes", "Better access"],
                        keywords: ["specialist", "waiting times", "capacity"],
                        category: "general"
                    }
                ];
                DATABASE_LOADED = true;
                return false;
            }
        }

        
        // Project Accordion Component
        function ProjectAccordion({ projects }) {
            const [expandedIndex, setExpandedIndex] = React.useState(null);
            
            const toggleProject = (index) => {
                setExpandedIndex(expandedIndex === index ? null : index);
            };
            
            return (
                <div className="proposal-card" style={{ padding: '28px' }}>
                    <h3 style={{ marginBottom: '20px', fontSize: '18px', color: 'var(--text-primary)' }}>
                        ðŸ“š Inspired by These NHS Partnerships
                    </h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                        {projects.map((project, idx) => (
                            <div key={idx} style={{ 
                                border: '1px solid var(--border-light)', 
                                borderRadius: '8px',
                                overflow: 'hidden',
                                background: 'white'
                            }}>
                                <button
                                    onClick={() => toggleProject(idx)}
                                    style={{
                                        width: '100%',
                                        padding: '14px 16px',
                                        background: expandedIndex === idx ? 'var(--bg-lighter)' : 'white',
                                        border: 'none',
                                        textAlign: 'left',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        fontFamily: 'inherit',
                                        fontSize: '15px',
                                        fontWeight: '500',
                                        color: 'var(--text-primary)',
                                        transition: 'background 0.2s'
                                    }}
                                >
                                    <span>{project.name}</span>
                                    <span style={{ fontSize: '18px', color: 'var(--novartis-blue)' }}>
                                        {expandedIndex === idx ? 'âˆ’' : '+'}
                                    </span>
                                </button>
                                {expandedIndex === idx && (
                                    <div style={{
                                        padding: '16px',
                                        background: 'var(--bg-lighter)',
                                        borderTop: '1px solid var(--border-lighter)',
                                        animation: 'fadeIn 0.2s'
                                    }}>
                                        <p style={{ 
                                            fontSize: '14px', 
                                            color: 'var(--text-secondary)', 
                                            marginBottom: '12px',
                                            lineHeight: '1.6'
                                        }}>
                                            <strong style={{ color: 'var(--text-primary)' }}>Focus:</strong> {project.focus}
                                        </p>
                                        {project.problem && (
                                            <p style={{ 
                                                fontSize: '14px', 
                                                color: 'var(--text-secondary)', 
                                                marginBottom: '12px',
                                                lineHeight: '1.6'
                                            }}>
                                                <strong style={{ color: 'var(--text-primary)' }}>Challenge:</strong> {project.problem}
                                            </p>
                                        )}
                                        {project.solution && (
                                            <p style={{ 
                                                fontSize: '14px', 
                                                color: 'var(--text-secondary)', 
                                                marginBottom: '12px',
                                                lineHeight: '1.6'
                                            }}>
                                                <strong style={{ color: 'var(--text-primary)' }}>Solution:</strong> {project.solution}
                                            </p>
                                        )}
                                        {project.sourceUrl && (
                                            <a 
                                                href={project.sourceUrl} 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                style={{
                                                    display: 'inline-flex',
                                                    alignItems: 'center',
                                                    gap: '6px',
                                                    fontSize: '14px',
                                                    color: 'var(--novartis-blue)',
                                                    textDecoration: 'none',
                                                    fontWeight: '500',
                                                    marginTop: '4px'
                                                }}
                                            >
                                                Read full case study â†’
                                            </a>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function App() {
            const [stage, setStage] = useState(1); // 1: Input, 2: Generation, 3: Output, 4: Email
            const [messages, setMessages] = useState([
                { role: 'assistant', content: 'Welcome to the Novartis Collaborative Working Project Generator! I\'m here to help you explore how a collaborative project could address your NHS challenge.\n\nTell me about a problem or opportunity you\'re facing in your organisation. What would you like to improve?' }
            ]);
            const [userInput, setUserInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [proposal, setProposal] = useState(null);
            const [videoScript, setVideoScript] = useState(null);
            const [matchedProjects, setMatchedProjects] = useState([]);
            const [emailData, setEmailData] = useState({
                name: '',
                email: '',
                organisation: '',
                role: '',
                consent: false
            });
            const [submitted, setSubmitted] = useState(false);
            const [generationStep, setGenerationStep] = useState(0); // 0: analysing, 1: searching, 2: generating
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // RAG Search Function
            const searchRelevantProjects = (query) => {
                const queryLower = query.toLowerCase();
                const scored = CWP_DATABASE.map(project => {
                    let score = 0;
                    project.keywords.forEach(keyword => {
                        if (queryLower.includes(keyword.toLowerCase())) {
                            score += 2;
                        }
                    });
                    if (queryLower.includes(project.category)) score += 3;
                    return { ...project, score };
                });

                return scored
                    .filter(p => p.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3);
            };

            // ============================================
            // ADAPTIVE CONVERSATION HELPERS
            // ============================================
            
            const extractOrganizationInfo = (text) => {
                const patterns = [
                    /(?:at|from|with|for|work(?:ing)?\s+(?:at|with))\s+([A-Z][a-zA-Z\s&'-]+(?:NHS Trust|Trust|ICS|ICB|Hospital|Health Board|Healthcare|CCG))/gi,
                    /([A-Z][a-zA-Z\s&'-]+(?:NHS Trust|Trust|ICS|ICB|Hospital|Health Board|Healthcare|CCG))/gi,
                    /(?:we're|we are)\s+([A-Z][a-zA-Z\s&'-]+)/gi,
                    /(?:I'm at|I work at)\s+([A-Z][a-zA-Z\s&'-]+)/gi
                ];
                
                for (const pattern of patterns) {
                    const matches = [...text.matchAll(pattern)];
                    if (matches.length > 0) {
                        return matches[0][1].trim();
                    }
                }
                return null;
            };

            const analyzeProvidedInfo = (userMessages) => {
                const fullText = userMessages.join(' ').toLowerCase();
                
                return {
                    hasOrganization: extractOrganizationInfo(userMessages.join(' ')) !== null,
                    hasMetrics: /\d+%|\d+ (patients?|hours?|days?|weeks?|months?)|\d+k|waiting time|capacity|throughput/i.test(fullText),
                    hasTimeline: /month|year|quarter|week|urgent|asap|by \d+/i.test(fullText),
                    hasConstraints: /budget|staff|resource|capacity|infrastructure|technology|limited|challenge/i.test(fullText),
                    hasSpecificGoal: /reduce|increase|improve|achieve|target|goal|outcome/i.test(fullText),
                    hasScope: /ward|department|trust-wide|system-wide|pathway|service|clinic/i.test(fullText),
                    hasProblemArea: /waiting|backlog|capacity|outcome|readmission|discharge|access|quality/i.test(fullText)
                };
            };

            const generateAdaptiveQuestion = (userMessages, messageCount) => {
                const allText = userMessages.join('\n\n');
                const orgName = extractOrganizationInfo(allText);
                const provided = analyzeProvidedInfo(userMessages);
                
                if (messageCount === 1) {
                    if (!provided.hasOrganization) {
                        return "Thanks for sharing that. Before we dive into solutions, could you tell me which Trust or ICS you're working with? This will help me tailor the proposal specifically for your organization.";
                    }
                    
                    let question = `Thanks for sharing that${orgName ? `, ${orgName}` : ''}. `;
                    const missingElements = [];
                    
                    if (!provided.hasMetrics) {
                        missingElements.push("â€¢ What are your current numbers? (e.g., waiting times, patient volumes, capacity)");
                    }
                    if (!provided.hasSpecificGoal) {
                        missingElements.push("â€¢ What specific improvement would you like to achieve?");
                    }
                    if (!provided.hasTimeline) {
                        missingElements.push("â€¢ What's your timeframe for seeing results?");
                    }
                    
                    if (missingElements.length > 0) {
                        question += "To create the most relevant solution, could you tell me:\n\n" + missingElements.join('\n');
                    } else {
                        question += "That's comprehensive. What are your main constraints or considerations? For example, workforce challenges, infrastructure needs, or operational factors.";
                    }
                    
                    return question;
                }
                
                if (messageCount === 2) {
                    const stillMissing = [];
                    
                    if (!provided.hasConstraints) {
                        stillMissing.push("â€¢ What constraints or challenges need to be considered?");
                    }
                    if (!provided.hasScope) {
                        stillMissing.push("â€¢ What's the scope? (e.g., single department, trust-wide, pathway)");
                    }
                    if (!provided.hasMetrics && !provided.hasSpecificGoal) {
                        stillMissing.push("â€¢ What does success look like in measurable terms?");
                    }
                    
                    if (stillMissing.length > 0) {
                        return `That's helpful${orgName ? `, ${orgName}` : ''}. A couple more things:\n\n` + stillMissing.join('\n');
                    }
                }
                
                return `Excellent${orgName ? `, ${orgName}` : ''}. I have a clear picture now. Let me create a highly personalised proposal that addresses your specific situation...`;
            };

            const buildStructuredContext = (userMessages) => {
                const allText = userMessages.join('\n\n');
                const orgName = extractOrganizationInfo(allText);
                const provided = analyzeProvidedInfo(userMessages);
                
                return {
                    organizationName: orgName,
                    challenge: userMessages[0],
                    specifics: userMessages[1] || '',
                    constraints: userMessages[2] || '',
                    fullContext: allText,
                    hasMetrics: provided.hasMetrics,
                    hasTimeline: provided.hasTimeline,
                    hasConstraints: provided.hasConstraints,
                    analyzedInfo: provided
                };
            };

            const handleSendMessage = async () => {
                if (!userInput.trim() || isLoading) return;

                const newMessages = [...messages, { role: 'user', content: userInput }];
                setMessages(newMessages);
                const currentInput = userInput;
                setUserInput('');
                setIsLoading(true);

                const messageCount = newMessages.filter(m => m.role === 'user').length;
                const userMessages = newMessages.filter(m => m.role === 'user').map(m => m.content);
                
                // Adaptive conversation based on what info is provided
                if (messageCount < 3) {
                    setTimeout(() => {
                        const followUp = generateAdaptiveQuestion(userMessages, messageCount);
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: followUp
                        }]);
                        setIsLoading(false);
                    }, 1000);
                    
                } else {
                    // Generate proposal with full context
                    setTimeout(() => {
                        const orgName = extractOrganizationInfo(userMessages.join(' '));
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: `Perfect${orgName ? `, ${orgName}` : ''}! I have a clear picture now. Let me create a highly personalised proposal that addresses your specific situation...`
                        }]);
                    }, 500);

                    setTimeout(async () => {
                        setStage(2);
                        setGenerationStep(0);
                        
                        await new Promise(resolve => setTimeout(resolve, 800));
                        setGenerationStep(1);
                        
                        // Build comprehensive context with org name
                        const comprehensiveContext = buildStructuredContext(userMessages);
                        
                        // Search for relevant projects
                        const relevant = searchRelevantProjects(comprehensiveContext.fullContext);
                        setMatchedProjects(relevant);
                        
                        await new Promise(resolve => setTimeout(resolve, 800));
                        setGenerationStep(2);

                        try {
                            // Pass rich context including org name to generation
                            const generatedProposal = await generateProposal(comprehensiveContext.fullContext, relevant, comprehensiveContext);
                            const generatedScript = generateVideoScript(generatedProposal);
                            
                            setProposal(generatedProposal);
                            setVideoScript(generatedScript);
                            setStage(3);
                            setGenerationStep(0);
                        } catch (error) {
                            console.error('Error generating proposal:', error);
                            setMessages(prev => [...prev, {
                                role: 'assistant',
                                content: 'I apologize, but I encountered an issue generating your proposal. Please try again or contact a Novartis representative at the stand.'
                            }]);
                            setStage(1);
                            setGenerationStep(0);
                        } finally {
                            setIsLoading(false);
                        }
                    }, 1500);
                }
            }

            // ============================================
            // BACKEND API INTEGRATION
            // ============================================
            
            const generateProposalWithBackend = async (userContext, relevantProjects, structuredContext) => {
                try {
                    const response = await fetch(`${CONFIG.BACKEND_API_URL}/generate-proposal`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                        },
                        cache: 'no-store', // Browser-level cache control
                        body: JSON.stringify({
                            userContext,
                            relevantProjects,
                            structuredContext,
                            timestamp: Date.now() // Cache-busting timestamp
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Backend API error');
                    }

                    const data = await response.json();
                    
                    if (!data.success || !data.proposal) {
                        throw new Error('Invalid response from backend');
                    }

                    // Transform backend response into our display format
                    const proposalData = data.proposal;
                    
                    return {
                        title: "Your Path to Transformation",
                        hookStatement: proposalData.hookStatement,
                        visionStatement: proposalData.visionStatement,
                        
                        theChallenge: {
                            headline: "The Reality You're Facing",
                            story: proposalData.challengeStory
                        },
                        
                        theOpportunity: {
                            headline: "What Collaborative Working Unlocks",
                            story: proposalData.opportunityStory,
                            examples: proposalData.exampleReference
                        },
                        
                        yourProject: {
                            headline: "How This Could Work for You",
                            story: proposalData.projectScenario,
                            timeline: proposalData.timelineNarrative
                        },
                        
                        theImpact: {
                            headline: "The Transformation in Numbers",
                            patients: {
                                icon: "ðŸ‘¥",
                                stats: proposalData.patientStats
                            },
                            organisation: {
                                icon: "ðŸ¥",
                                stats: proposalData.organisationStats
                            },
                            system: {
                                icon: "ðŸŒŸ",
                                stats: proposalData.systemStats
                            }
                        },
                        
                        whyItWorks: {
                            headline: "Why This Approach Succeeds",
                            principles: [
                                {
                                    title: "Proven, Not Theoretical",
                                    description: proposalData.principleDescriptions.proven
                                },
                                {
                                    title: "Built for NHS Reality",
                                    description: proposalData.principleDescriptions.realistic
                                },
                                {
                                    title: "Partnership, Not Transaction",
                                    description: proposalData.principleDescriptions.partnership
                                },
                                {
                                    title: "Sustainable by Design",
                                    description: proposalData.principleDescriptions.sustainable
                                }
                            ]
                        },
                        
                        nextSteps: {
                            headline: "Making This Real",
                            story: proposalData.nextStepsStory,
                            cta: proposalData.closingCTA
                        },
                        
                        matchedProjects: relevantProjects,
                        duration: "12 months"
                    };

                } catch (error) {
                    console.error('Backend API Error:', error);
                    throw error;
                }
            };

            // ============================================
            // CLAUDE API INTEGRATION (DIRECT - NOT RECOMMENDED FOR PRODUCTION)
            // ============================================
            
            const generateProposalWithClaude = async (userContext, relevantProjects) => {
                const systemPrompt = `You are an expert healthcare transformation consultant specializing in NHS collaborative working projects. Your role is to create INSPIRATIONAL, narrative-driven proposals that show stakeholders how their challenges can be solved through partnership with Novartis.

CRITICAL INSTRUCTIONS:
- Write in an INSPIRATIONAL, STORYTELLING style, NOT a formal executive summary
- Use "imagine this", "picture this", "envision" language to paint vivid scenarios
- Make the transformation feel ACHIEVABLE and REAL
- Include SPECIFIC metrics (e.g., "60-80% reduction") based on real CWP outcomes
- Be EMPATHETIC to NHS pressures and constraints
- Focus on PARTNERSHIP language, not sales pitch
- Keep tone OPTIMISTIC but REALISTIC

OUTPUT FORMAT (JSON):
{
  "hookStatement": "Opening 'Imagine this...' statement personalised to their challenge",
  "visionStatement": "One-sentence transformation vision",
  "challengeStory": "Empathetic 2-3 sentence acknowledgment of their reality",
  "opportunityStory": "2-3 sentences about what collaborative working unlocks",
  "exampleReference": "One sentence about a similar organisation's success",
  "projectScenario": "Vivid 3-4 sentence description of how this could work for them",
  "timelineNarrative": "One sentence describing progressive 12-month transformation",
  "patientStats": ["stat 1", "stat 2", "stat 3", "stat 4"],
  "organisationStats": ["stat 1", "stat 2", "stat 3", "stat 4"],
  "systemStats": ["stat 1", "stat 2", "stat 3", "stat 4"],
  "principleDescriptions": {
    "proven": "Brief description of why it's proven",
    "realistic": "Brief description of NHS fit",
    "partnership": "Brief description of partnership approach",
    "sustainable": "Brief description of sustainability"
  },
  "nextStepsStory": "2-3 sentences inviting conversation without pressure",
  "closingCTA": "One compelling sentence question to end with"
}`;

                const userPrompt = `USER CONTEXT (their challenge):
${userContext}

MATCHED COLLABORATIVE WORKING PROJECTS (use as inspiration):
${relevantProjects.map((p, idx) => `
${idx + 1}. ${p.name}
   Focus: ${p.focus}
   Problem: ${p.problem}
   Solution: ${p.solution}
   Benefits: ${p.benefits.join(', ')}
`).join('\n')}

TASK:
Generate an INSPIRATIONAL transformation story that shows how a collaborative working project could address their specific challenge. Use the matched projects as proof points but personalise the narrative to their context.

REMEMBER:
- Paint a vivid picture of the transformed future state
- Show specific, measurable outcomes (use realistic percentages)
- Make it feel achievable, not pie-in-the-sky
- Use warm, inviting language for next steps
- Include specific stats based on real CWP outcomes

Return ONLY valid JSON with no markdown formatting or code fences.`;

                try {
                    const response = await fetch(CONFIG.CLAUDE_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': CONFIG.CLAUDE_API_KEY,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: CONFIG.CLAUDE_MODEL,
                            max_tokens: 4000,
                            temperature: 0.8, // Higher for more creative storytelling
                            system: systemPrompt,
                            messages: [
                                { role: 'user', content: userPrompt }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    const content = data.content[0].text;
                    
                    // Parse JSON response (remove any markdown formatting if present)
                    const cleanContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    const proposalData = JSON.parse(cleanContent);
                    
                    // Validate required fields
                    if (!proposalData.hookStatement || !proposalData.projectScenario) {
                        throw new Error('Invalid proposal structure');
                    }

                    // Transform API response into our display format
                    return {
                        title: "Your Path to Transformation",
                        hookStatement: proposalData.hookStatement,
                        visionStatement: proposalData.visionStatement,
                        
                        theChallenge: {
                            headline: "The Reality You're Facing",
                            story: proposalData.challengeStory
                        },
                        
                        theOpportunity: {
                            headline: "What Collaborative Working Unlocks",
                            story: proposalData.opportunityStory,
                            examples: proposalData.exampleReference
                        },
                        
                        yourProject: {
                            headline: "How This Could Work for You",
                            story: proposalData.projectScenario,
                            timeline: proposalData.timelineNarrative
                        },
                        
                        theImpact: {
                            headline: "The Transformation in Numbers",
                            patients: {
                                icon: "ðŸ‘¥",
                                stats: proposalData.patientStats
                            },
                            organisation: {
                                icon: "ðŸ¥",
                                stats: proposalData.organisationStats
                            },
                            system: {
                                icon: "ðŸŒŸ",
                                stats: proposalData.systemStats
                            }
                        },
                        
                        whyItWorks: {
                            headline: "Why This Approach Succeeds",
                            principles: [
                                {
                                    title: "Proven, Not Theoretical",
                                    description: proposalData.principleDescriptions.proven
                                },
                                {
                                    title: "Built for NHS Reality",
                                    description: proposalData.principleDescriptions.realistic
                                },
                                {
                                    title: "Partnership, Not Transaction",
                                    description: proposalData.principleDescriptions.partnership
                                },
                                {
                                    title: "Sustainable by Design",
                                    description: proposalData.principleDescriptions.sustainable
                                }
                            ]
                        },
                        
                        nextSteps: {
                            headline: "Making This Real",
                            story: proposalData.nextStepsStory,
                            cta: proposalData.closingCTA
                        },
                        
                        matchedProjects: relevantProjects,
                        duration: "12 months"
                    };

                } catch (error) {
                    console.error('Claude API Error:', error);
                    // Fall back to mock generation
                    return generateProposalMock(userContext, relevantProjects);
                }
            };

            // Mock generator (fallback and for testing without API key)
            const generateProposalMock = (userContext, relevantProjects) => {
                // Create an inspirational narrative-driven proposal
                // In production, this would use Claude API with storytelling prompts
                
                const userContextLower = userContext.toLowerCase();
                
                // Detect key themes from user input
                const themes = {
                    waitingTimes: userContextLower.includes('waiting') || userContextLower.includes('backlog') || userContextLower.includes('delay'),
                    capacity: userContextLower.includes('capacity') || userContextLower.includes('staff') || userContextLower.includes('resource'),
                    access: userContextLower.includes('access') || userContextLower.includes('reach') || userContextLower.includes('rural'),
                    quality: userContextLower.includes('quality') || userContextLower.includes('outcome') || userContextLower.includes('standard'),
                    integration: userContextLower.includes('integration') || userContextLower.includes('coordination') || userContextLower.includes('fragmented')
                };
                
                // Create personalised narrative opening
                let storyOpening = "Imagine this: ";
                if (themes.waitingTimes) {
                    storyOpening += "Your patients no longer face months-long waits. Instead, they're seen within weeks, receiving the specialist care they need before their condition worsens.";
                } else if (themes.capacity) {
                    storyOpening += "Your clinical teams have the capacity they need. Specialists focus on complex cases while enhanced services handle routine reviews, and everyone feels empowered rather than overwhelmed.";
                } else if (themes.access) {
                    storyOpening += "Care comes to your patients, wherever they are. Community clinics, digital consultations, and local services bring specialist expertise closer to home.";
                } else {
                    storyOpening += "Your organisation transforms how it delivers care. Patients get better outcomes, staff feel supported, and your trust becomes a model for others to follow.";
                }
                
                // Build the transformation story
                const visionStatement = themes.waitingTimes 
                    ? "transforming waiting lists into rapid-access pathways"
                    : themes.capacity
                    ? "multiplying your clinical capacity without burning out your team"
                    : themes.access
                    ? "bringing specialist care to every corner of your community"
                    : "reimagining healthcare delivery for the modern NHS";
                
                return {
                    title: "Your Path to Transformation",
                    hookStatement: storyOpening,
                    visionStatement: visionStatement,
                    
                    theChallenge: {
                        headline: "The Reality You're Facing",
                        story: "Right now, you're experiencing the pressures that many NHS organisations face: demand outpacing capacity, patients waiting too long, and dedicated staff stretched thin. You know things need to change, but transforming healthcare delivery while maintaining daily operations feels impossible. That's exactly where collaborative working makes the difference."
                    },
                    
                    theOpportunity: {
                        headline: "What Collaborative Working Unlocks",
                        story: "Through partnership with Novartis, organisations like yours have achieved remarkable transformations. Not through massive budgets or unrealistic plans, but through smart, focused interventions: deploying specialist roles where they're needed most, implementing proven pathways, and leveraging technology to do more with what you have.",
                        examples: relevantProjects.length > 0 
                            ? `Organisations like ${relevantProjects[0].name} faced similar challenges. They ${relevantProjects[0].solution.toLowerCase()}, and the results spoke for themselves.`
                            : "Organisations across the UK have successfully implemented these approaches, creating lasting change."
                    },
                    
                    yourProject: {
                        headline: "How This Could Work for You",
                        story: themes.waitingTimes
                            ? "Picture a specialist working directly within your service, focusing exclusively on clearing backlogs and optimizing patient flow. They bring immediate capacity while training your existing team on enhanced protocols. Within months, your waiting lists shrink, urgent cases are prioritized correctly, and patients start receiving timely care."
                            : themes.capacity
                            ? "Imagine adding focused clinical capacity exactly where bottlenecks occur. A dedicated specialist role, combined with streamlined pathways and decision-support tools, could double your effective capacity without doubling your headcount. Your current team gets support, not more burden."
                            : themes.access
                            ? "Envision specialist services extending into community settings. Through enhanced training, technology enablement, and hub-and-spoke models, expertise reaches patients where they live. Travel time drops, clinic space opens up, and more patients access care they previously couldn't reach."
                            : "Think about what's possible when you combine clinical expertise, proven methodologies, and enabling technology. Your organisation doesn't just solve today's problemsâ€”you build capacity for tomorrow's challenges.",
                        
                        timeline: "Over 12 months, you'd see progressive transformation: immediate capacity gains in months 1-3, optimized pathways by month 6, measurable outcome improvements by month 9, and a fully sustainable model by month 12."
                    },
                    
                    theImpact: {
                        headline: "The Transformation in Numbers",
                        patients: {
                            icon: "ðŸ‘¥",
                            stats: [
                                "60-80% reduction in waiting times for specialist appointments",
                                "90%+ patient satisfaction with access to care",
                                "Earlier interventions leading to better health outcomes",
                                "Reduced emergency admissions through proactive management"
                            ]
                        },
                        organisation: {
                            icon: "ðŸ¥",
                            stats: [
                                "2-3x increase in patient throughput with same resources",
                                "50%+ reduction in 'did not attend' rates through better pathways",
                                "Enhanced staff satisfaction and professional development",
                                "Proven model for securing long-term NHS funding"
                            ]
                        },
                        system: {
                            icon: "ðŸŒŸ",
                            stats: [
                                "Reduced pressure on emergency services",
                                "Improved integration between primary and secondary care",
                                "Replicable model for other specialties",
                                "Contribution to system-wide health outcomes"
                            ]
                        }
                    },
                    
                    whyItWorks: {
                        headline: "Why This Approach Succeeds",
                        principles: [
                            {
                                title: "Proven, Not Theoretical",
                                description: "Every element is based on successful implementations across the NHS"
                            },
                            {
                                title: "Built for NHS Reality",
                                description: "Designed to work within existing budgets, systems, and constraints"
                            },
                            {
                                title: "Partnership, Not Transaction",
                                description: "Novartis supports the journey, sharing expertise and resources"
                            },
                            {
                                title: "Sustainable by Design",
                                description: "Creates lasting capability, not temporary fixes"
                            }
                        ]
                    },
                    
                    nextSteps: {
                        headline: "Making This Real",
                        story: "This isn't just an ideaâ€”it's a proven pathway that organisations like yours have successfully walked. The next step is simple: let's have a conversation. We'll explore your specific context, adapt the model to your needs, and chart a realistic path forward. No pressure, no commitmentâ€”just an opportunity to explore what's possible.",
                        cta: "Ready to explore how this could transform your service?"
                    },
                    
                    matchedProjects: relevantProjects,
                    duration: "12 months"
                };
            };

            // Main proposal generator - routes to backend, API, or mock based on config
            const generateProposal = async (userContext, relevantProjects, structuredContext = null) => {
                // Priority 1: Use secure backend API (RECOMMENDED)
                if (CONFIG.USE_BACKEND) {
                    console.log('Using secure backend API with structured context:', structuredContext);
                    try {
                        return await generateProposalWithBackend(userContext, relevantProjects, structuredContext);
                    } catch (error) {
                        console.error('Backend failed, falling back to mock');
                        return generateProposalMock(userContext, relevantProjects);
                    }
                }
                
                // Priority 2: Use direct Claude API (NOT RECOMMENDED - exposes API key)
                if (!CONFIG.USE_MOCK_API && CONFIG.CLAUDE_API_KEY) {
                    console.log('Using Claude API directly (WARNING: API key exposed in frontend)');
                    return await generateProposalWithClaude(userContext, relevantProjects);
                }
                
                // Priority 3: Use mock generation
                console.log('Using mock API (no backend or API key configured)');
                return generateProposalMock(userContext, relevantProjects);
            };

            const generateVideoScript = (proposal) => {
                return {
                    title: "Your Transformation Story",
                    duration: "60 seconds",
                    style: "Inspirational healthcare transformation narrative - blend of real NHS settings, data visualizations, and patient/staff testimonial aesthetics",
                    scenes: [
                        {
                            time: "0-8s",
                            visuals: "Opening: Busy NHS corridor, staff moving purposefully, patients in waiting areas. Slow zoom showing the pressure and activity.",
                            narration: "Every day, NHS organisations face impossible choices. More patients, limited resources, and staff giving everything they have.",
                            mood: "Empathetic, realistic"
                        },
                        {
                            time: "8-15s",
                            visuals: "Transition to close-up of concerned faces - a manager reviewing waiting lists, a clinician looking at backlogs. Screen shows: 'What if there was a better way?'",
                            narration: "But what if the solution isn't working harderâ€”it's working differently? What if proven innovations could transform your service?",
                            mood: "Questioning, hopeful transition"
                        },
                        {
                            time: "15-30s",
                            visuals: "Montage of transformation: Specialist meeting with team, digital dashboard showing improved metrics, patient receiving care in modern clinic, staff collaborating confidently.",
                            narration: "Through collaborative working, NHS organisations are achieving remarkable results. New specialist capacity where it's needed. Streamlined pathways that work. Technology that enables, not burdens. And patients receiving timely, excellent care.",
                            mood: "Energetic, optimistic, showing action"
                        },
                        {
                            time: "30-45s",
                            visuals: "Split screen showing 'before/after' metrics: waiting times dropping, patient satisfaction rising, staff engagement improving. Include animated infographics with real impact numbers.",
                            narration: "The impact? Waiting times cut by 60%. Patient satisfaction soaring. Clinical teams empowered. And a sustainable model that continues delivering long after the project ends.",
                            mood: "Confident, data-driven, impressive"
                        },
                        {
                            time: "45-58s",
                            visuals: "Return to the NHS setting, but transformed: Patients smiling in appointments, staff energized and collaborative, manager presenting successful results to board. End with handshake between NHS and Novartis representatives.",
                            narration: "This isn't just possibleâ€”it's happening right now across the NHS. Organisations like yours are already on this journey. The question is: are you ready to explore what's possible for your patients?",
                            mood: "Inspiring call to action"
                        },
                        {
                            time: "58-60s",
                            visuals: "Clean branded end card: 'Collaborative Working with Novartis' + 'NHS Confed Expo 2026' + QR code/contact details. Novartis logo + NHS partnership visual.",
                            narration: "Let's start the conversation.",
                            mood: "Professional, inviting"
                        }
                    ],
                    productionNotes: {
                        voiceStyle: "Professional British voice, warm and inspiring tone, female or male, pace: measured but energetic",
                        visualStyle: "Real NHS settings with cinematic quality, smooth transitions, data visualizations in Novartis blue, inspirational without being unrealistic",
                        music: "Uplifting ambient corporate, builds from thoughtful to energetic, fades for voice clarity",
                        branding: "Novartis blue (#003da5) throughout graphics, minimal text on screen, focus on visual storytelling"
                    }
                };
            };

            const handleEmailSubmit = (e) => {
                e.preventDefault();
                if (emailData.consent) {
                    setSubmitted(true);
                    // In production, this would send data to backend
                    console.log('Submitting:', emailData);
                }
            };

            const handleRestart = () => {
                setStage(1);
                setMessages([
                    { role: 'assistant', content: 'Welcome back! Tell me about another challenge you\'d like to explore.' }
                ]);
                setProposal(null);
                setVideoScript(null);
                setMatchedProjects([]);
                setEmailData({ name: '', email: '', organisation: '', role: '', consent: false });
                setSubmitted(false);
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>ðŸ¤ Collaborative Working Project Generator</h1>
                        <p>A Festival of Ideas | NHS Confed Expo 2026 | Powered by Novartis</p>
                    </div>

                    <div className="content">
                        {/* Stage Indicator */}
                        <div className="stage-indicator">
                            <div className="stage">
                                <div className={`stage-dot ${stage >= 1 ? 'active' : ''} ${stage > 1 ? 'completed' : ''}`}>1</div>
                                <div className="stage-label">Share Your Challenge</div>
                            </div>
                            <div className="stage">
                                <div className={`stage-dot ${stage >= 2 ? 'active' : ''} ${stage > 2 ? 'completed' : ''}`}>2</div>
                                <div className="stage-label">AI Generation</div>
                            </div>
                            <div className="stage">
                                <div className={`stage-dot ${stage >= 3 ? 'active' : ''} ${stage > 3 ? 'completed' : ''}`}>3</div>
                                <div className="stage-label">Review Proposal</div>
                            </div>
                            <div className="stage">
                                <div className={`stage-dot ${stage >= 4 ? 'active' : ''}`}>4</div>
                                <div className="stage-label">Get Your Assets</div>
                            </div>
                        </div>

                        {/* Stage 1: Chat Interface */}
                        {stage === 1 && (
                            <div className="chat-interface">
                                <div className="messages">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`message ${msg.role}`}>
                                            {msg.content}
                                        </div>
                                    ))}
                                    {isLoading && (
                                        <div className="message assistant">
                                            <div className="loading-spinner"></div>
                                            <span style={{ marginLeft: '10px' }}>Thinking...</span>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>
                                
                                <div className="input-area">
                                    <textarea
                                        value={userInput}
                                        onChange={(e) => setUserInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage())}
                                        placeholder="Describe your challenge or idea..."
                                        rows="3"
                                        disabled={isLoading}
                                    />
                                    <button 
                                        className="btn btn-primary" 
                                        onClick={handleSendMessage}
                                        disabled={isLoading || !userInput.trim()}
                                    >
                                        {isLoading ? <div className="loading-spinner"></div> : 'Send'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Stage 2: Enhanced Generating UI */}
                        {stage === 2 && (
                            <div className="generating-container">
                                <div className="generating-spinner"></div>
                                <h2 className="generating-title">Creating Your Proposal</h2>
                                <p className="generating-subtitle">Our AI is analysing your challenge and crafting a personalised solution...</p>
                                
                                <div className="generating-steps">
                                    <div className={`generating-step ${generationStep >= 0 ? (generationStep === 0 ? 'active' : 'completed') : ''}`}>
                                        <div className="generating-step-icon">{generationStep > 0 ? 'âœ“' : 'ðŸ”'}</div>
                                        <div className="generating-step-text">Analysing your challenge</div>
                                    </div>
                                    <div className={`generating-step ${generationStep >= 1 ? (generationStep === 1 ? 'active' : 'completed') : ''}`}>
                                        <div className="generating-step-icon">{generationStep > 1 ? 'âœ“' : 'ðŸ“š'}</div>
                                        <div className="generating-step-text">Searching project database</div>
                                    </div>
                                    <div className={`generating-step ${generationStep >= 2 ? 'active' : ''}`}>
                                        <div className="generating-step-icon">âœ¨</div>
                                        <div className="generating-step-text">Generating personalised proposal</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Stage 3: Proposal Display */}
                        {stage === 3 && proposal && (
                            <>
                                {/* Hero Statement */}
                                <div style={{ 
                                    background: 'linear-gradient(135deg, var(--novartis-blue) 0%, var(--novartis-blue-dark) 100%)', 
                                    color: 'white', 
                                    textAlign: 'center', 
                                    padding: '48px 40px',
                                    borderRadius: '12px',
                                    marginBottom: '24px',
                                    boxShadow: 'var(--shadow-md)'
                                }}>
                                    <h2 style={{ color: 'white', fontSize: '28px', fontWeight: '600', marginBottom: '16px', letterSpacing: '-0.3px' }}>{proposal.title}</h2>
                                    <p style={{ fontSize: '18px', lineHeight: '1.7', marginBottom: '0', color: 'white', opacity: '0.95' }}>{proposal.hookStatement}</p>
                                </div>

                                {/* The Vision */}
                                <div className="proposal-card">
                                    <div style={{ textAlign: 'center', marginBottom: '30px' }}>
                                        <h2 style={{ fontSize: '28px', marginBottom: '15px' }}>ðŸŽ¯ The Opportunity</h2>
                                        <p style={{ fontSize: '18px', color: '#666', fontStyle: 'italic' }}>
                                            {proposal.visionStatement}
                                        </p>
                                    </div>

                                    <h3>{proposal.theChallenge.headline}</h3>
                                    <p style={{ fontSize: '16px' }}>{proposal.theChallenge.story}</p>

                                    <h3 style={{ marginTop: '30px' }}>{proposal.theOpportunity.headline}</h3>
                                    <p style={{ fontSize: '16px' }}>{proposal.theOpportunity.story}</p>
                                    {proposal.theOpportunity.examples && (
                                        <p style={{ fontSize: '16px', background: '#f0f7ff', padding: '15px', borderRadius: '8px', borderLeft: '4px solid #003da5' }}>
                                            <strong>Real Example:</strong> {proposal.theOpportunity.examples}
                                        </p>
                                    )}
                                </div>

                                {/* The Project Vision */}
                                <div className="proposal-card" style={{ background: '#f8f9fa' }}>
                                    <h2>{proposal.yourProject.headline}</h2>
                                    <p style={{ fontSize: '17px', lineHeight: '1.8' }}>{proposal.yourProject.story}</p>
                                    <div style={{ background: 'white', padding: '20px', borderRadius: '10px', marginTop: '20px', borderLeft: '4px solid #4caf50' }}>
                                        <strong>ðŸ“… Timeline:</strong>
                                        <p style={{ marginTop: '10px', marginBottom: '0' }}>{proposal.yourProject.timeline}</p>
                                    </div>
                                </div>

                                {/* The Impact */}
                                <div className="proposal-card">
                                    <h2 style={{ textAlign: 'center', marginBottom: '30px' }}>{proposal.theImpact.headline}</h2>
                                    
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '20px' }}>
                                        <div style={{ background: '#e3f2fd', padding: '20px', borderRadius: '12px' }}>
                                            <div style={{ fontSize: '32px', marginBottom: '10px' }}>{proposal.theImpact.patients.icon}</div>
                                            <h4 style={{ color: '#003da5', marginBottom: '15px' }}>For Your Patients</h4>
                                            {proposal.theImpact.patients.stats.map((stat, idx) => (
                                                <div key={idx} style={{ marginBottom: '12px', paddingLeft: '10px', borderLeft: '3px solid #003da5' }}>
                                                    <p style={{ margin: '0', fontSize: '14px', lineHeight: '1.6' }}>{stat}</p>
                                                </div>
                                            ))}
                                        </div>

                                        <div style={{ background: '#e8f5e9', padding: '20px', borderRadius: '12px' }}>
                                            <div style={{ fontSize: '32px', marginBottom: '10px' }}>{proposal.theImpact.organisation.icon}</div>
                                            <h4 style={{ color: '#2e7d32', marginBottom: '15px' }}>For Your Organisation</h4>
                                            {proposal.theImpact.organisation.stats.map((stat, idx) => (
                                                <div key={idx} style={{ marginBottom: '12px', paddingLeft: '10px', borderLeft: '3px solid #4caf50' }}>
                                                    <p style={{ margin: '0', fontSize: '14px', lineHeight: '1.6' }}>{stat}</p>
                                                </div>
                                            ))}
                                        </div>

                                        <div style={{ background: '#fff3e0', padding: '20px', borderRadius: '12px' }}>
                                            <div style={{ fontSize: '32px', marginBottom: '10px' }}>{proposal.theImpact.system.icon}</div>
                                            <h4 style={{ color: '#e65100', marginBottom: '15px' }}>System-Wide Benefits</h4>
                                            {proposal.theImpact.system.stats.map((stat, idx) => (
                                                <div key={idx} style={{ marginBottom: '12px', paddingLeft: '10px', borderLeft: '3px solid #ff9800' }}>
                                                    <p style={{ margin: '0', fontSize: '14px', lineHeight: '1.6' }}>{stat}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Why It Works */}
                                <div className="proposal-card" style={{ background: '#f8f9fa' }}>
                                    <h2 style={{ textAlign: 'center', marginBottom: '25px' }}>{proposal.whyItWorks.headline}</h2>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '20px' }}>
                                        {proposal.whyItWorks.principles.map((principle, idx) => (
                                            <div key={idx} style={{ textAlign: 'center' }}>
                                                <div style={{ 
                                                    width: '60px', 
                                                    height: '60px', 
                                                    background: '#003da5', 
                                                    color: 'white', 
                                                    borderRadius: '50%', 
                                                    display: 'flex', 
                                                    alignItems: 'center', 
                                                    justifyContent: 'center', 
                                                    margin: '0 auto 15px',
                                                    fontSize: '24px',
                                                    fontWeight: 'bold'
                                                }}>
                                                    {idx + 1}
                                                </div>
                                                <h4 style={{ color: '#003da5', marginBottom: '10px' }}>{principle.title}</h4>
                                                <p style={{ fontSize: '14px', color: '#666', margin: '0' }}>{principle.description}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Next Steps */}
                                <div className="proposal-card" style={{ background: 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)', color: 'white', textAlign: 'center' }}>
                                    <h2 style={{ color: 'white', marginBottom: '20px' }}>{proposal.nextSteps.headline}</h2>
                                    <p style={{ fontSize: '17px', lineHeight: '1.7', marginBottom: '20px' }}>{proposal.nextSteps.story}</p>
                                    <p style={{ fontSize: '20px', fontWeight: '600', marginBottom: '0' }}>{proposal.nextSteps.cta}</p>
                                </div>

                                {matchedProjects.length > 0 && <ProjectAccordion projects={matchedProjects} />}

                                {/* Video Preview */}
                                <div className="video-placeholder">
                                    <div className="video-icon">ðŸŽ¬</div>
                                    <h3>Your Project Video is Being Created</h3>
                                    <p style={{ opacity: 0.7, marginTop: '10px' }}>A 60-second visualization of your transformation journey</p>
                                    <p style={{ opacity: 0.7, fontSize: '14px' }}>(In production: powered by Google Veo 3)</p>
                                </div>

                                <div className="action-buttons">
                                    <button className="btn btn-secondary" onClick={handleRestart}>
                                        Explore Another Idea
                                    </button>
                                    <button className="btn btn-primary" onClick={() => setStage(4)}>
                                        Get My Assets â†’
                                    </button>
                                </div>
                            </>
                        )}

                        {/* Stage 4: Email Capture */}
                        {stage === 4 && (
                            <div className="email-form">
                                {!submitted ? (
                                    <>
                                        <h3>ðŸ“§ Receive Your Project Assets</h3>
                                        <p style={{ marginBottom: '25px', color: '#666' }}>
                                            We'll email you the full project proposal, video, and additional resources. 
                                            A Novartis representative may follow up to discuss collaboration opportunities.
                                        </p>

                                        <form onSubmit={handleEmailSubmit}>
                                            <div className="form-group">
                                                <label>Full Name *</label>
                                                <input
                                                    type="text"
                                                    required
                                                    value={emailData.name}
                                                    onChange={(e) => setEmailData({ ...emailData, name: e.target.value })}
                                                    placeholder="Jane Smith"
                                                />
                                            </div>

                                            <div className="form-group">
                                                <label>Email Address *</label>
                                                <input
                                                    type="email"
                                                    required
                                                    value={emailData.email}
                                                    onChange={(e) => setEmailData({ ...emailData, email: e.target.value })}
                                                    placeholder="jane.smith@nhs.net"
                                                />
                                            </div>

                                            <div className="form-group">
                                                <label>Organisation *</label>
                                                <input
                                                    type="text"
                                                    required
                                                    value={emailData.organisation}
                                                    onChange={(e) => setEmailData({ ...emailData, organisation: e.target.value })}
                                                    placeholder="NHS Trust / ICB"
                                                />
                                            </div>

                                            <div className="form-group">
                                                <label>Your Role *</label>
                                                <input
                                                    type="text"
                                                    required
                                                    value={emailData.role}
                                                    onChange={(e) => setEmailData({ ...emailData, role: e.target.value })}
                                                    placeholder="e.g., Chief Operating Officer"
                                                />
                                            </div>

                                            <div className="checkbox-group">
                                                <input
                                                    type="checkbox"
                                                    id="consent"
                                                    checked={emailData.consent}
                                                    onChange={(e) => setEmailData({ ...emailData, consent: e.target.checked })}
                                                />
                                                <label htmlFor="consent">
                                                    I consent to receiving the project materials and agree that Novartis 
                                                    may contact me to discuss potential collaborative working opportunities. 
                                                    All data will be handled in accordance with GDPR regulations. *
                                                </label>
                                            </div>

                                            <div className="action-buttons">
                                                <button type="button" className="btn btn-secondary" onClick={() => setStage(3)}>
                                                    Back
                                                </button>
                                                <button type="submit" className="btn btn-primary" disabled={!emailData.consent}>
                                                    Send My Assets
                                                </button>
                                            </div>
                                        </form>
                                    </>
                                ) : (
                                    <>
                                        <div className="success-message">
                                            <h3>âœ… Success!</h3>
                                            <p>Your project assets have been sent to <strong>{emailData.email}</strong></p>
                                            <p style={{ marginTop: '15px' }}>
                                                Check your inbox for the full proposal, video, and next steps. 
                                                A Novartis representative will be in touch soon.
                                            </p>
                                        </div>

                                        <div className="action-buttons">
                                            <button className="btn btn-primary" onClick={handleRestart}>
                                                Create Another Project
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {/* Version Footer */}
                    <div className="version-footer">
                        <div className="version-details">
                            <div className="version-item">
                                <span className="version-label">Version:</span>
                                <span>{BUILD_INFO.version}</span>
                            </div>
                            <div className="version-item">
                                <span className="version-label">Deployed:</span>
                                <span>{BUILD_INFO.date} GMT</span>
                            </div>
                            <div className="version-item">
                                <span className="version-label">Build:</span>
                                <span>{BUILD_INFO.timestamp.substring(0, 19).replace('T', ' ')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Load database before rendering app
        loadDatabase().then(() => {
            ReactDOM.render(<App />, document.getElementById('root'));
        });
    
    </script>
</body>
</html>
